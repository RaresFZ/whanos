---
title: Whanos Kubernetes Deployment Guide
---

## Jenkins service account bootstrap

Apply `kubernetes/base/jenkins-rbac.yaml` once per cluster to create the `whanos-cicd` namespace and the `whanos-deployer` ServiceAccount. Configure Jenkins with a kubeconfig that authenticates as this service account (or use workload identity) to apply per-application manifests generated by the renderer.

## Rendering application manifests

For daily operations, prefer the CLI helper:

```bash
whanos-deploy \
  --config whanos.yml \
  --image registry.whanos.example.com/whanos/apps/sample:abcd123 \
  --app sample \
  --domain apps.whanos.example.com
```

Behind the scenes, `whanos-deploy` calls `kubernetes/render_deployment.py`, which consumes the `whanos.yml` file located at the root of an application repository and produces a set of Kubernetes manifests tailored to that application:

```bash
python kubernetes/render_deployment.py \
  --config whanos.yml \
  --image registry.whanos.example.com/whanos/apps/sample:abcd123 \
  --app sample \
  --namespace whanos-sample \
  --deployer-service-account whanos-cicd/whanos-deployer \
  --domain apps.whanos.example.com \
  --output-dir build/manifests
```

### Generated resources

| File               | Description                                                                                     |
|--------------------|-------------------------------------------------------------------------------------------------|
| `namespace.yaml`   | Ensures a dedicated namespace per app (`whanos-<app>`) with labels for inventory/cleanup.      |
| `deployment.yaml`  | Deploys the container image with replicas, resources, and ports derived from `whanos.yml`.      |
| `service.yaml`     | Exposes declared ports using the requested `Service` type (`ClusterIP` by default).             |
| `ingress.yaml`     | Optional; created when `--expose-mode ingress` and a `--domain` are supplied.                   |
| `role.yaml`        | Namespaced RBAC granting create/update/delete on relevant resources.                            |
| `rolebinding.yaml` | Binds the per-app role to Jenkins' deployer service account (namespace/name configurable).      |

When `--output-dir` is omitted, manifests are streamed to stdout separated by `---`. Integrate this script into the Jenkins pipeline after a successful image push; pipe the output to `kubectl apply -f -`.

### Exposure modes

- `ingress` (default): requires a cluster ingress controller and a base domain. First declared port is published via host `app.<domain>`. Provide `--tls-secret` to enable HTTPS termination with a pre-created secret.
- `nodeport`: sets the Service type to `NodePort` and allocates deterministic ports starting at 30000 (tune with `--nodeport-base`). Suitable for bare-metal clusters without ingress.
- `clusterip`: leaves the Service internal only; useful when another layer (e.g., Istio) performs exposure.

### Resource requests/limits

Any `deployment.resources` structure in `whanos.yml` is copied directly under the container's `resources`. For example:

```yaml
deployment:
  replicas: 2
  ports: [8080]
  resources:
    requests:
      cpu: "200m"
      memory: "256Mi"
    limits:
      cpu: "500m"
      memory: "512Mi"
```

### Integrating pull secrets

If the registry requires authentication, create a `whanos-registry` secret per namespace and instruct the renderer (or a post-processing step) to add it to the Deployment:

```bash
kubectl create secret docker-registry whanos-registry \
  --docker-server=registry.whanos.example.com \
  --docker-username=ci \
  --docker-password='***' \
  --namespace whanos-sample
```

Then patch the generated `deployment.yaml` with:

```yaml
spec:
  template:
    spec:
      imagePullSecrets:
        - name: whanos-registry
```

(Future enhancement: add `--image-pull-secret` flag to the renderer.)

## CI/CD integration blueprint

1. Jenkins pipeline completes image build and push.
2. Pipeline calls `whanos-deploy --output-dir build/manifests --dry-run` (or directly invokes the renderer) to produce manifests.
3. Jenkins applies manifests using the deployer service account:
   ```bash
   kubectl --kubeconfig=/var/lib/jenkins/kubeconfigs/whanos.config \
     apply -f build/manifests
   ```
4. Optional: run `kubectl rollout status deployment/<app>` to verify rollout success and `whanos-events --app <app> --follow` to watch live events.
